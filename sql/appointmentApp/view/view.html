<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modern Booking Form - Bootstrap 5</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .card { border: none; border-radius: 1rem; box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05); }
        .btn-primary { background-color: #0d6efd; border: none; padding: 0.8rem; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s; }
        .form-control { padding: 0.75rem 1rem; border-radius: 0.75rem; }
    </style>
</head>
<body class="min-vh-100 d-flex align-items-center justify-content-center p-3">

    <div class="card w-100" style="max-width: 450px;">
        <div class="card-body p-4 p-md-5">
            <div class="mb-4">
                <h1 class="h3 fw-bold text-dark">Create Booking</h1>
                <p class="text-muted small">Fill in the details below to secure your spot.</p>
            </div>

            <form id="bookingForm">
                <div class="mb-3">
                    <label for="name" class="form-label fw-semibold text-secondary small">Full Name</label>
                    <input type="text" id="name" name="name" required class="form-control" placeholder="John Doe">
                </div>
                <div class="mb-4">
                    <label for="email" class="form-label fw-semibold text-secondary small">Email Address</label>
                    <input type="email" id="email" name="email" required class="form-control" placeholder="john@example.com">
                </div>
                <button type="submit" class="btn btn-primary w-100 shadow-sm">Confirm Booking</button>
            </form>

            <div id="status" class="mt-3 text-center d-none"></div>
            <div id="list" class="mt-4"></div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const bookingForm = document.querySelector('#bookingForm');
            const statusDiv = document.querySelector('#status');
            const listDiv = document.querySelector('#list');

            const showStatus = (msg, colorClass) => {
                statusDiv.innerText = msg;
                statusDiv.className = `mt-3 text-center fw-medium ${colorClass}`;
                statusDiv.classList.remove('d-none');
            };

            const displayData = (data) => {
                // If data is just one object (from POST), wrap it in an array so forEach works
                const items = Array.isArray(data) ? data : [data];
                
                items.forEach((item) => {
                    const html = `
                    <div class="alert alert-light border border-1 d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <div class="fw-bold small">${item.name}</div>
                            <div class="text-muted" style="font-size: 0.8rem;">${item.email}</div>
                        </div>
                        <span class="badge bg-primary-subtle text-primary rounded-pill">Saved</span>
                    </div>`;
                    listDiv.insertAdjacentHTML('afterbegin', html);
                });
            };

            const saveBooking = async (name = '', email = '') => {
                try {
                    const isGet = (name === '' || email === '');
                    const method = isGet ? 'GET' : 'POST';
                    
                    const options = {
                        method: method,
                        headers: { 'Content-Type': 'application/json' }
                    };

                    // CRITICAL: body is NOT allowed for GET requests
                    if (!isGet) {
                        options.body = JSON.stringify({ name, email });
                    }

                    const res = await fetch('/booking', options);
                    if (!res.ok) throw new Error(`Status: ${res.status}`);
                    
                    return await res.json();
                } catch (error) {
                    console.error('Error:', error.message);
                    return null;
                }
            };

            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameVal = document.querySelector('#name').value;
                const emailVal = document.querySelector('#email').value;
                
                const result = await saveBooking(nameVal, emailVal);
                if (result) {
                    displayData(result);
                    showStatus("Booking confirmed!", "text-success");
                    bookingForm.reset();
                } else {
                    showStatus("Failed to save booking.", "text-danger");
                }
            });

            // Run on page load to show existing data
            const init = async () => {
                const initialData = await saveBooking();
                if (initialData) displayData(initialData);
            };

            init();
        });
    </script>
</body>
</html>